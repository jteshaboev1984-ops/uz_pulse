<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PULSE App</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- –î–ò–ó–ê–ô–ù (CSS) --- */
        :root {
            --bg-color: #1a1a1a; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –∫–∞–∫ –≤ docx */
            --card-bg: #2c2c2c;
            --accent: #3390ec;
            --text-main: #ffffff;
            --text-hint: #aaaaaa;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding: 0; padding-bottom: 90px; }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤–Ω–∏–∑—É */
        .nav { position: fixed; bottom: 0; width: 100%; background: #222; border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 10px 0; z-index: 1000; }
        .nav-btn { background: none; border: none; color: var(--text-hint); font-size: 10px; display: flex; flex-direction: column; align-items: center; }
        .nav-btn.active { color: var(--accent); }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { display: none; padding: 20px; animation: fadeIn 0.4s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        h2 { margin: 0 0 16px 0; font-size: 22px; font-weight: 700; }
        
        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        label { display: block; color: var(--text-hint); font-size: 13px; margin-bottom: 6px; }
        select, input { width: 100%; background: #111; border: 1px solid #444; color: white; padding: 14px; border-radius: 12px; font-size: 16px; margin-bottom: 16px; box-sizing: border-box; }
        .main-btn { width: 100%; background: var(--accent); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; }
        
        /* –ö–∞—Ä—Ç–∞ */
        #map { height: 250px; width: 100%; border-radius: 12px; margin-top: 10px; }
        
        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .avatar-circle { width: 80px; height: 80px; background: var(--accent); border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: bold; }
        .stat-row { display: flex; gap: 10px; margin-top: 15px; }
        .stat-item { flex: 1; background: #333; padding: 10px; border-radius: 10px; text-align: center; }
        .badge-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .badge { background: #333; padding: 10px; border-radius: 10px; text-align: center; opacity: 0.4; filter: grayscale(1); }
        .badge.active { opacity: 1; filter: none; border: 1px solid var(--accent); background: rgba(51, 144, 236, 0.1); }
    </style>
</head>
<body>

    <div id="screen-input" class="screen active">
        <h2>üìù –ù–æ–≤—ã–π –æ—Ç—á–µ—Ç</h2>
        <div class="card">
            <label>–¢–æ–≤–∞—Ä / –£—Å–ª—É–≥–∞</label>
            <select id="product">
                <option value="strawberry_egg">üçì –ö–ª—É–±–Ω–∏–∫–∞ / –Ø–π—Ü–æ</option>
                <option value="plov_laziness">üçõ –ü–ª–æ–≤ (–î–æ—Å—Ç–∞–≤–∫–∞)</option>
                <option value="milk_eco">ü•õ –ú–æ–ª–æ–∫–æ (–≠–∫–æ)</option>
                <option value="tutor">üéì –†–µ–ø–µ—Ç–∏—Ç–æ—Ä</option>
            </select>
            
            <label>–ú–µ—Å—Ç–æ –ø–æ–∫—É–ø–∫–∏</label>
            <select id="location">
                <option value="korzinka">üõí –ö–æ—Ä–∑–∏–Ω–∫–∞</option>
                <option value="bazaar">üé™ –ë–∞–∑–∞—Ä</option>
                <option value="delivery">üöö –î–æ—Å—Ç–∞–≤–∫–∞</option>
                <option value="center">üè´ –£—á–µ–±–Ω—ã–π —Ü–µ–Ω—Ç—Ä</option>
            </select>

            <label>–¶–µ–Ω–∞ (–≤ —Å—É–º–∞—Ö)</label>
            <input type="number" id="price" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 15000">
            
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <span style="font-size: 20px;">üìç</span>
                <span id="geo-status" style="font-size: 13px; color: #888;">–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è...</span>
            </div>

            <button class="main-btn" onclick="submitData()" id="btn-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="screen-stats" class="screen">
        <h2>üìä –ö–∞—Ä—Ç–∞ —Ü–µ–Ω</h2>
        <div class="card">
            <div id="map"></div> <p style="font-size: 12px; color: #888; text-align: center; margin-top: 5px;">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Ç–æ—á–µ–∫</p>
        </div>

        <div class="card">
            <h3>–°—Ä–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã</h3>
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="card" style="text-align: center;">
            <div class="avatar-circle" id="avatar">?</div>
            <h2 id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
            <p style="color: #888; font-size: 12px;" id="userid">ID: ...</p>
            
            <div class="stat-row">
                <div class="stat-item">
                    <div style="font-size: 20px; font-weight: bold; color: var(--accent);" id="count">0</div>
                    <div style="font-size: 10px;">–û—Ç—á–µ—Ç–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div style="font-size: 20px; font-weight: bold; color: #f1c40f;" id="xp">0</div>
                    <div style="font-size: 10px;">XP –û–ø—ã—Ç</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>üèÖ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
            <div class="badge-grid">
                <div class="badge" id="b1">üê£<br><span style="font-size:10px">–°—Ç–∞—Ä—Ç</span></div>
                <div class="badge" id="b5">üñêÔ∏è<br><span style="font-size:10px">–ê–∫—Ç–∏–≤</span></div>
                <div class="badge" id="b10">üöÄ<br><span style="font-size:10px">–ü—Ä–æ—Ñ–∏</span></div>
            </div>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="go('input')" id="nav-input">
            <span class="nav-icon">‚úèÔ∏è</span>–í–≤–æ–¥
        </button>
        <button class="nav-btn" onclick="go('stats')" id="nav-stats">
            <span class="nav-icon">üåç</span>–ò–Ω—Ñ–æ
        </button>
        <button class="nav-btn" onclick="go('profile')" id="nav-profile">
            <span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- ‚ö†Ô∏è –í–°–¢–ê–í–¨ –ö–õ–Æ–ß–ò –°–Æ–î–ê ‚ö†Ô∏è ---
        const SB_URL = 'https://psmtnxrbjdvyapjdcfxb.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzbXRueHJiamR2eWFwamRjZnhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NjY1OTEsImV4cCI6MjA4NDA0MjU5MX0.eaTvnG9CX7K2TgaI0Qd0yz-fC-IpbxnGyLldDT2qdoI';
        
        const db = window.supabase.createClient(SB_URL, SB_KEY);
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = tg.initDataUnsafe?.user || { id: 11111, first_name: 'TestUser' };
        let myLat = null;
        let myLng = null;
        let map = null;

        // –ó–ê–ü–£–°–ö
        init();

        async function init() {
            // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —é–∑–µ—Ä–∞
            document.getElementById('username').innerText = currentUser.first_name;
            document.getElementById('avatar').innerText = currentUser.first_name[0];
            document.getElementById('userid').innerText = 'ID: ' + currentUser.id;

            // 2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤ –±–∞–∑–µ (—Ç–∏—Ö–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
            await db.from('users').upsert({ 
                telegram_id: currentUser.id, 
                full_name: currentUser.first_name, 
                role: 'agent' 
            }, { onConflict: 'telegram_id' });

            // 3. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º GPS
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        myLat = pos.coords.latitude;
                        myLng = pos.coords.longitude;
                        document.getElementById('geo-status').innerText = "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞ ‚úÖ";
                        document.getElementById('geo-status').style.color = "#4cd137";
                    },
                    (err) => {
                        document.getElementById('geo-status').innerText = "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚ùå";
                    }
                );
            }
        }

        // –ù–ê–í–ò–ì–ê–¶–ò–Ø
        function go(screenName) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('screen-' + screenName).classList.add('active');
            document.getElementById('nav-' + screenName).classList.add('active');

            if (screenName === 'stats') loadAnalytics();
            if (screenName === 'profile') loadProfile();
        }

        // –û–¢–ü–†–ê–í–ö–ê –û–¢–ß–ï–¢–ê
        async function submitData() {
            const btn = document.getElementById('btn-submit');
            const price = document.getElementById('price').value;
            
            if (!price) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É!");

            btn.innerText = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
            btn.disabled = true;

            const { error } = await db.from('submissions').insert({
                user_id: currentUser.id,
                index_slug: document.getElementById('product').value,
                location_type: document.getElementById('location').value,
                price: Number(price),
                lat: myLat, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                lng: myLng
            });

            if (error) {
                tg.showAlert("–û—à–∏–±–∫–∞: " + error.message);
            } else {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showPopup({ title: '–ü—Ä–∏–Ω—è—Ç–æ!', message: '–°–ø–∞—Å–∏–±–æ –∑–∞ –¥–∞–Ω–Ω—ã–µ.' });
                document.getElementById('price').value = '';
                go('profile');
            }
            btn.innerText = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
            btn.disabled = false;
        }

        // –ó–ê–ì–†–£–ó–ö–ê –ö–ê–†–¢–´ –ò –ì–†–ê–§–ò–ö–û–í
        async function loadAnalytics() {
            // –°–∫–∞—á–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 –∑–∞–ø–∏—Å–µ–π
            const { data } = await db.from('submissions').select('*').order('created_at', { ascending: false }).limit(50);
            
            if (!data) return;

            // 1. –†–ò–°–£–ï–ú –ö–ê–†–¢–£
            // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ - —Å–æ–∑–¥–∞–µ–º
            if (!map) {
                map = L.map('map').setView([41.31, 69.24], 11); // –¶–µ–Ω—Ç—Ä –¢–∞—à–∫–µ–Ω—Ç–∞
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬©OSM'
                }).addTo(map);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É
            data.forEach(row => {
                if (row.lat && row.lng) {
                    L.marker([row.lat, row.lng])
                        .addTo(map)
                        .bindPopup(`<b>${row.index_slug}</b><br>${row.price} —Å—É–º`);
                }
            });

            // 2. –†–ò–°–£–ï–ú –ì–†–ê–§–ò–ö
            const products = {};
            data.forEach(row => {
                if (!products[row.index_slug]) products[row.index_slug] = [];
                products[row.index_slug].push(row.price);
            });
            const labels = Object.keys(products);
            const averages = labels.map(s => products[s].reduce((a,b)=>a+b,0) / products[s].length);

            const ctx = document.getElementById('priceChart');
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: '–°—Ä. —Ü–µ–Ω–∞', data: averages, backgroundColor: '#3390ec', borderRadius: 8 }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { grid: { color: '#333' } } }
                }
            });
        }

        // –ü–†–û–§–ò–õ–¨
        async function loadProfile() {
            const { count } = await db.from('submissions').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id);
            const total = count || 0;
            
            document.getElementById('count').innerText = total;
            document.getElementById('xp').innerText = total * 10;

            if (total >= 1) document.getElementById('b1').classList.add('active');
            if (total >= 5) document.getElementById('b5').classList.add('active');
            if (total >= 10) document.getElementById('b10').classList.add('active');
        }
    </script>
</body>
</html>
