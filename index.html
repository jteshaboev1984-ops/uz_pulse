<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PULSE</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --text: #f8fafc; --hint: #94a3b8;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }
        
        /* –°–¢–ê–†–¢–û–í–´–ô –≠–ö–†–ê–ù */
        #screen-welcome { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; box-sizing: border-box; }
        .welcome-icon { font-size: 80px; margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .nav { position: fixed; bottom: 0; width: 100%; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); border-top: 1px solid #334155; display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; }
        .nav-btn { background: none; border: none; color: var(--hint); font-size: 10px; display: flex; flex-direction: column; align-items: center; }
        .nav-btn.active { color: var(--accent); }
        .nav-icon { font-size: 24px; margin-bottom: 4px; }

        /* –≠–ö–†–ê–ù–´ */
        .screen { display: none; padding: 20px; animation: fadeIn 0.4s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –≠–õ–ï–ú–ï–ù–¢–´ */
        .card { background: var(--card); border-radius: 16px; padding: 16px; margin-bottom: 16px; border: 1px solid #334155; }
        h1 { font-size: 28px; margin: 0 0 10px 0; background: linear-gradient(90deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        h2 { font-size: 20px; margin: 0 0 15px 0; font-weight: 600; }
        label { display: block; color: var(--hint); font-size: 13px; margin-bottom: 6px; font-weight: 500; }
        
        select, input { width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 14px; border-radius: 12px; font-size: 16px; margin-bottom: 16px; box-sizing: border-box; outline: none; }
        select:focus, input:focus { border-color: var(--accent); }
        
        .main-btn { width: 100%; background: var(--accent); color: white; border: none; padding: 16px; border-radius: 14px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); transition: transform 0.1s; }
        .main-btn:active { transform: scale(0.98); }

        /* –§–û–¢–û –ó–ê–ì–†–£–ó–ö–ê */
        .file-upload { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; border: 2px dashed #334155; border-radius: 12px; background: rgba(15, 23, 42, 0.5); margin-bottom: 16px; }
        .file-upload input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        /* –ö–ê–†–¢–ê –ò –ë–ï–ô–î–ñ–ò */
        #map { height: 220px; width: 100%; border-radius: 12px; margin-top: 10px; z-index: 1; }
        .badge-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .badge { background: #0f172a; padding: 10px; border-radius: 12px; text-align: center; opacity: 0.3; filter: grayscale(1); border: 1px solid #334155; }
        .badge.active { opacity: 1; filter: none; border-color: var(--accent); background: rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body>

    <div id="screen-welcome">
        <div class="welcome-icon">üá∫üáø</div>
        <h1>PULSE Monitor</h1>
        <p style="color: #94a3b8; margin-bottom: 40px; font-size: 16px;">
            –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥<br>—ç–∫–æ–Ω–æ–º–∏–∫–∏ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞
        </p>
        <button class="main-btn" onclick="startApp()">–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É üöÄ</button>
    </div>

    <div id="screen-input" class="screen">
        <h2>üìù –ù–æ–≤—ã–π –æ—Ç—á–µ—Ç</h2>
        <div class="card">
            <label>–¢–æ–≤–∞—Ä</label>
            <select id="product">
                <option value="strawberry_egg">üçì –ö–ª—É–±–Ω–∏–∫–∞ / –Ø–π—Ü–æ</option>
                <option value="plov_laziness">üçõ –ü–ª–æ–≤ (–î–æ—Å—Ç–∞–≤–∫–∞)</option>
                <option value="milk_eco">ü•õ –ú–æ–ª–æ–∫–æ (–≠–∫–æ)</option>
                <option value="tutor">üéì –†–µ–ø–µ—Ç–∏—Ç–æ—Ä</option>
            </select>
            
            <label>–ú–µ—Å—Ç–æ</label>
            <select id="location">
                <option value="korzinka">üõí –ö–æ—Ä–∑–∏–Ω–∫–∞</option>
                <option value="bazaar">üé™ –ë–∞–∑–∞—Ä</option>
                <option value="delivery">üöö –î–æ—Å—Ç–∞–≤–∫–∞</option>
            </select>

            <label>–¶–µ–Ω–∞ (—Å—É–º)</label>
            <input type="number" id="price" placeholder="15000">
            
            <label>–§–æ—Ç–æ —Ü–µ–Ω–Ω–∏–∫–∞ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <div class="file-upload" id="drop-zone">
                <span style="font-size: 24px">üì∑</span>
                <span id="file-label" style="font-size: 12px; margin-top: 5px">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
                <input type="file" id="photo-input" accept="image/*">
            </div>

            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <span id="geo-status" style="font-size: 12px; color: #4cd137;">üìç GPS –Ω–∞–π–¥–µ–Ω</span>
            </div>

            <button class="main-btn" onclick="submitData()" id="btn-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</button>
        </div>
    </div>

    <div id="screen-stats" class="screen">
        <h2>üìä –ö–∞—Ä—Ç–∞ –∏ –¢—Ä–µ–Ω–¥—ã</h2>
        <div class="card">
            <div id="map"></div>
        </div>
        <div class="card">
            <canvas id="priceChart"></canvas>
        </div>
        <div class="card">
            <h3 style="margin-top:0">–û –ü—Ä–æ–µ–∫—Ç–µ</h3>
            <p style="font-size: 13px; color: #aaa; line-height: 1.4;">
                –ü—Ä–æ–µ–∫—Ç <b>¬´–ü–£–õ–¨–°¬ª</b> –∏—Å—Å–ª–µ–¥—É–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∂–∏–∑–Ω–∏. –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–æ—Ä–∏–∏ "–ë–æ–ª–µ–∑–Ω–∏ —Ü–µ–Ω" –∏ "–≠—Ñ—Ñ–µ–∫—Ç–∞ –í–µ–±–ª–µ–Ω–∞" –Ω–∞ —Ä—ã–Ω–∫–∞—Ö –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞.
            </p>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="card" style="text-align: center; padding-top: 30px;">
            <div style="width: 80px; height: 80px; background: var(--accent); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; color: white;" id="avatar">?</div>
            <h2 id="username">–í–æ–ª–æ–Ω—Ç–µ—Ä</h2>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <div style="flex: 1; background: #0f172a; padding: 10px; border-radius: 10px;">
                    <div style="font-size: 24px; font-weight: bold; color: var(--accent);" id="count">0</div>
                    <div style="font-size: 10px; color: #64748b;">–û–¢–ß–ï–¢–û–í</div>
                </div>
                <div style="flex: 1; background: #0f172a; padding: 10px; border-radius: 10px;">
                    <div style="font-size: 24px; font-weight: bold; color: #facc15;" id="xp">0</div>
                    <div style="font-size: 10px; color: #64748b;">XP –û–ü–´–¢</div>
                </div>
            </div>
        </div>

        <div class="card">
            <label>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</label>
            <div class="badge-grid">
                <div class="badge" id="b1">üèÅ<br><span style="font-size:9px">–°—Ç–∞—Ä—Ç</span></div>
                <div class="badge" id="b5">üî•<br><span style="font-size:9px">–ê–∫—Ç–∏–≤</span></div>
                <div class="badge" id="b10">üíé<br><span style="font-size:9px">–≠–ª–∏—Ç–∞</span></div>
            </div>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="go('input')" id="nav-input"><span class="nav-icon">‚úèÔ∏è</span>–í–≤–æ–¥</button>
        <button class="nav-btn" onclick="go('stats')" id="nav-stats"><span class="nav-icon">üåç</span>–ò–Ω—Ñ–æ</button>
        <button class="nav-btn" onclick="go('profile')" id="nav-profile"><span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ‚ö†Ô∏è –í–°–¢–ê–í–¨ –ö–õ–Æ–ß–ò –ù–ò–ñ–ï ‚ö†Ô∏è
        const URL = 'https://psmtnxrbjdvyapjdcfxb.supabase.co';
        const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzbXRueHJiamR2eWFwamRjZnhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NjY1OTEsImV4cCI6MjA4NDA0MjU5MX0.eaTvnG9CX7K2TgaI0Qd0yz-fC-IpbxnGyLldDT2qdoI';
        
        const db = window.supabase.createClient(URL, KEY);
        
        let user = tg.initDataUnsafe?.user || { id: 11111, first_name: 'Test' };
        let myLat = null, myLng = null, map = null, uploadedPhotoUrl = null;

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –§–û–¢–û (–ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∞–π–ª–∞)
        document.getElementById('photo-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('file-label').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞... ‚è≥";
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞: user_id + –≤—Ä–µ–º—è.jpg
            const fileName = `${user.id}/${Date.now()}.jpg`;
            
            const { data, error } = await db.storage.from('photos').upload(fileName, file);
            
            if (error) {
                alert("–û—à–∏–±–∫–∞ —Ñ–æ—Ç–æ: " + error.message);
                document.getElementById('file-label').innerText = "–û—à–∏–±–∫–∞ ‚ùå";
            } else {
                // –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É
                const { data: { publicUrl } } = db.storage.from('photos').getPublicUrl(fileName);
                uploadedPhotoUrl = publicUrl;
                document.getElementById('file-label').innerText = "–§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ ‚úÖ";
                document.getElementById('drop-zone').style.borderColor = "#4cd137";
            }
        });

        function startApp() {
            document.getElementById('screen-welcome').style.display = 'none';
            document.getElementById('screen-input').classList.add('active');
            initLogic();
        }

        async function initLogic() {
            document.getElementById('username').innerText = user.first_name;
            document.getElementById('avatar').innerText = user.first_name[0];
            
            // –¢–∏—Ö–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            await db.from('users').upsert({ telegram_id: user.id, full_name: user.first_name }, { onConflict: 'telegram_id' });
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => { myLat = pos.coords.latitude; myLng = pos.coords.longitude; });
            }
        }

        function go(screen) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('screen-' + screen).classList.add('active');
            document.getElementById('nav-' + screen).classList.add('active');
            if (screen === 'stats') loadStats();
            if (screen === 'profile') loadProfile();
        }

        async function submitData() {
            const btn = document.getElementById('btn-submit');
            const price = document.getElementById('price').value;
            if (!price) return tg.showAlert("–ù—É–∂–Ω–∞ —Ü–µ–Ω–∞!");

            btn.disabled = true; btn.innerText = "‚è≥";

            const { error } = await db.from('submissions').insert({
                user_id: user.id,
                index_slug: document.getElementById('product').value,
                location_type: document.getElementById('location').value,
                price: Number(price),
                lat: myLat,
                lng: myLng,
                photo_url: uploadedPhotoUrl // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ
            });

            btn.disabled = false; btn.innerText = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";

            if (!error) {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showPopup({ title: '–ü—Ä–∏–Ω—è—Ç–æ!', message: '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∫–ª–∞–¥!' });
                document.getElementById('price').value = '';
                document.getElementById('file-label').innerText = "–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ";
                uploadedPhotoUrl = null;
                go('profile');
            }
        }

        async function loadStats() {
            const { data } = await db.from('submissions').select('*').order('created_at', {ascending:false}).limit(50);
            if (!data) return;

            // –ö–∞—Ä—Ç–∞
            if (!map) {
                map = L.map('map').setView([41.31, 69.24], 10);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {attribution: '¬©OSM'}).addTo(map);
            }
            data.forEach(row => {
                if (row.lat) L.marker([row.lat, row.lng]).addTo(map).bindPopup(`${row.price} —Å—É–º`);
            });

            // –ì—Ä–∞—Ñ–∏–∫
            const products = {};
            data.forEach(row => { if(!products[row.index_slug]) products[row.index_slug]=[]; products[row.index_slug].push(row.price); });
            const avg = Object.keys(products).map(k => products[k].reduce((a,b)=>a+b,0)/products[k].length);
            
            const ctx = document.getElementById('priceChart');
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'doughnut', // –ö—Ä–∞—Å–∏–≤—ã–π –∫—Ä—É–≥–ª—ã–π –≥—Ä–∞—Ñ–∏–∫
                data: { labels: Object.keys(products), datasets: [{ data: avg, backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b'], borderWidth: 0 }] },
                options: { plugins: { legend: { position: 'right', labels: { color: 'white', font: {size: 10} } } } }
            });
        }

        async function loadProfile() {
            const { count } = await db.from('submissions').select('*', { count: 'exact', head: true }).eq('user_id', user.id);
            const n = count || 0;
            document.getElementById('count').innerText = n;
            document.getElementById('xp').innerText = n * 10;
            if (n >= 1) document.getElementById('b1').classList.add('active');
            if (n >= 5) document.getElementById('b5').classList.add('active');
            if (n >= 10) document.getElementById('b10').classList.add('active');
        }
    </script>
</body>
</html>
